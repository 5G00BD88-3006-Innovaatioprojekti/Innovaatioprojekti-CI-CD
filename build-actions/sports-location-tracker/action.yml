name: Build Sports Location Tracker
inputs:
  env:
    required: true

runs:
  using: composite
  steps:
    - name: Retag previous images
      shell: bash
      run: >-
        docker tag slt_webapp:${{ github.event.inputs.env }} slt_webapp:${{ github.event.inputs.env }}_previous
        && docker tag slt_server:${{ github.event.inputs.env }} slt_server:${{ github.event.inputs.env }}_previous
        && docker tag slt_db:${{ github.event.inputs.env }} slt_db:${{ github.event.inputs.env }}_previous
        exit 0
    - name: Remove untagged images
      shell: bash
      run: docker rmi $(docker images | grep "^<none>" | awk "{print $3}")
    - name: Build images
      shell: bash
      run: |
        cd ~/repositories/Sports-Location-Tracker-Public
        docker build -t slt_webapp:${{ github.event.inputs.env }} -f .dockerfiles/webapp.Dockerfile .
        docker build -t slt_server:${{ github.event.inputs.env }} --build-arg NODE_ENV=production -f .dockerfiles/server.Dockerfile .
        docker build -t slt_db:${{ github.event.inputs.env }} -f .dockerfiles/db.Dockerfile .
